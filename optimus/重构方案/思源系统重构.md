# 思源系统--内部版页面重构

### 为什么要用react


|  lib  | star        | watch           | fork  | iusse |
|------:| ----------- |:---------------:| :-----:| :-----:|
|react  | 78,546      | 5,036           | 14,873| 296 |
| vue   |70,380      | 3,911           | 10,222| 45 |
| angular|28,792      | 2,691           | 72,202|1,843 |
| jQuery |46,718      | 3,496           | 13,688|78 |

## 思源系统为什么要重构
> 这些都是我的问题

> 对新方案也是从0到1 踩出的一些坑 — 也是收获

### 分享几个案例

- https://ke.youdao.com/

- http://hui.netease.com/

- http://salon.netease.com/

- http://github.com 

- https://youdata.netease.com/

- http://console.easemob.com/

- http://kefu.easemob.com/ 

### 问题

| 问题 | 是否修改 |
| :------------------------------------------------- | :---------------------------: |
| 没有借用uikit提升质量、效率、体验 | √ |
| 进入每个页面 出现404问题 | √ |
| 当进入一个页面，没有权限，跳到登录页,登录后跳转到index页 | √ |
| 可否用地址栏定位到某个tab 和 某个页(有些页面是按需加载的数据) | ㄨ |
| 目录结构优化| √ |
| js按需加载| √ |
| 获取权限通过接口拉数据问题| ㄨ√ |
| 下拉列表体验问题| √ |
| 随着迭代，左侧导航内容越来越多，一屏显示不下| √ |
| 动态清用户缓存 | √ |
| 当用户没有权限的时候依然可以访问| √ |
| 源文件瘦身 | ㄨ√  |
| 切换状态保留原页面状态 | ㄨ√ |


### 实践方案
- 产品规划
- 高内聚、低耦合原则 √
- “解耦”是为了“复用”
- antd 最简组件的封装和复用
- react单向“数据流”
-  redux数据状态共享
- react高阶组件  （暂时驾驭不了）ㄨ
- 简单的需求，用简单的方式去实践
- 复杂的需求，寻求一种简单的方式去实践（降低复杂维度）

### 重构的三种情况
- 人员变动，被交接人无法向上迭代
- 出现迭代瓶颈
- 优化

#### 优化有两种
- 第一种是基于原有架构上进行优化
	- 优化要比重构复杂度高，工期长，风险大
- 第二种是重构 
	- 项目据有可重构性

#### 思源为什么考虑重构优化
1. 因为之前的做法存在大的问题（比如路由用法）
1. 自己开发基础组件，组件缺乏健壮性。
1. 之前驾驭不了antd现在可以驾驭了。
1. 还有一些其它的问题，导致优化要比重构复杂


### 强视觉弱视觉
- http://shengxi.sinaapp.com/kefu/UIkit/webim/ui_structure.html


## 重构方案

|  技术栈(提升）ㄨ          | 技术栈(保守) √   |
|:------------------:| :----------------: |
| nginx  转发            |                   |
| nodejs(express)            |                   |
| react               | react              |
| react-router （恶梦）      |react-router （恶梦）       |
| history       |hash                     |
| 动态路由切割         |   动态路由切割                  |
| redux              |redux               |
| SSR（Server-sent Events）  |                    |
| antd        |antd         |
| es7-fetch          | es7-fetch / reqwest       |
|     cors      |           |
|     token      |           |
|     webpack      |   webpack        |
|     mockjs      |   mockjs        |
|     TaffyDB      |   TaffyDB        |
| jQuery          | jQuery           |
| echarts          | echarts           |
| pm2          |           |
|           |  webpack-dev-server         |

## 目录结构

``` 

/**
 * 整体是线性目录结构
 */

.
├── build                                                                       # 打包后的js文件
│   ├── index.html
│   └── webpack.assets.js                                   
├── package.json
├── src                                                                         # 源文件
│   ├── actions                                                                 一、redux 的actions 
│   │   ├── profileList
│   │   │   ├── profileList.js
│   │   └── userList
│   │       └── userList.js
│   ├── app.js                                                                  二、入口文件app.js
│   ├── common                                                                  三、公共文件
│   │   ├── chartConfigs.js                                                     1、echarts 全局配置模板
│   │   └── utils.js                                                            2、全局方法
│   ├── components                                                              四、页面组件
│   │   ├── data
│   │   │   └── data.js
│   │   ├── dataLeftNav
│   │   │   └── dataLeftNav.js
│   │   ├── kpi
│   │   │   ├── kpiDetail.js
│   │   │   └── kpi.js
│   │   ├── main.js                                                             1、组件入口文件
│   │   ├── noAllow                                                             2、没有权限显示的组件
│   │   │   └── noAllow.js
│   │   ├── profile                                                             3、用户概况
│   │   │   └── profileList.js
│   │   ├── topNav                                                              4、顶部导航
│   │   │   └── topNav.js
│   │   ├── user                                                                5、用户列表
│   │   │   └── userList.js
│   │   └── userLeftNav                                                         6、用户左侧导航
│   │       └── userLeftNav.js
│   ├── mock                                                                    五、模拟接口
│   │   ├── common                                                              1、全局接口
│   │   │   └── global.js
│   │   ├── profileList                                                         2、用户概况模块所需要的接口
│   │   │   └── profileList.js
│   │   └── userList                                                            3、用户列表模块所需要的接口
│   │       ├── systemUser.json
│   │       └── userList.js
│   ├── reducers                                                                六、redux的reducer
│   │   ├── data.js
│   │   ├── profileList                                                         1、用户概况模块所需要的数据
│   │   │   ├── profileList.js
│   │   │   ├── Result.js
│   │   │   └── TableColumns.js
│   │   └── userList                                                            2、用户列表所需要的数据
│   │       ├── addUser.js
│   │       ├── list.js
│   │       ├── listParam.js
│   │       └── listTable.js
│   ├── routers                                                                 七、路由配置
│   │   └── config.js                                                           1、路由配置文件
│   └── theme                                                                   八、页面样式所存放的文件
│       ├── antd.css                                                            1、antd样式
│       ├── channel.less                                                        2、改变后的全局样式
│       ├── profile                                                             3、用户概况所需要的样式
│       │   └── profile.css                                     
│       └── topNav                                                              4、顶部导航所需要的样式
│           └── topNav.css
├── templates                                                                   # 页面模板
│   └── demo.html                                               
├── webpack.config.js                                                           # 本地环境
├── webpack.push.config.js                                                      # 测试环境和生产环境
└── yarn.lock                                                   

```


## 命令使用

- npm start  -- 本地运行(localhost:8089)
- npm run dev -- 打包发布到测试环境或生产环境


## 代码示列

### 模拟数据

> /src/mock/userList/userList.js

``` javascript
import Mock from 'mockjs';

/** 
 * 用户列表
 * 参数
 * {
 *      offset:1,
 *      limit:10,
 *      name:""
 * }
 */
 
Mock.mock("/user/list.do", "post", {
	"msg": "返回成功",
	"total": "@natural(1000, 10000)",
	"data|10": [{
		"cname": "@cname",
		"ctime": "@datetime('yyyy-MM-dd')",
		"email": "@email",
		"ltime": "@datetime('yyyy-MM-dd')",
		"name": "@cname",
		"uid": "@natural(1000, 10000)"
	}],
	"status": true
});

/** 
 * 删除列表
 * 参数
 * {
 *     id:102
 * }
 */
Mock.mock("/user/delete.do", "post", {
	"msg": "删除成功",
	"status|1": false
});

/**
 * 添加用户检查邮箱是否重复
 * 参数
 * { 
 *     "email":"asdf@corp.netease.com"      
 * }
 */
Mock.mock("/user/unique.do", "post", {
	"msg": "邮箱可用",
	"status|1": true
});

/**
 * 添加用户
 * 参数
 * { 
 *    "email":"asdf@corp.netease.com",
 *    "name":asdf,
 *    "auth":1      
 * }
 */
Mock.mock("/user/add.do", "post", {
	"msg": "添加成功",
	"status|1": true
});

/**
 * 获取要修改的数据
 * {
 *      id:100
 * }
 */
Mock.mock("/user/get.do", "post", {
	"msg": "",
	"data": {
		"cname": "@cname",
		"ctime": "@datetime('yyyy-MM-dd')",
		"email": "@last()" + "@corp.netease.com",
		"ltime": "2018-01-28",
		"mid": "1,2",
		"name": "@datetime('yyyy-MM-dd')",
		"uid": "@natural(1000, 10000)"
	},
	"status": true
});

/**
 * 修改用户
 * {
 *      "auth":1,
 *      "name":aaaaa,
 *      "id":100    
 * }
 */
Mock.mock("/user/update.do", "post", {
	"msg": "修改成功!",
	"status": true
});

/**
 * 获取当前登录的用户信息
 */
Mock.mock("/system/user.do", "post", {
	"msg": "",
	"data": {
		"auth": "1,4",
		"name": "@cname",
		"userName": "@last()"
	},
	"status": true
});


```




### 公共文件

> /src/common/utils.js

``` javascript 

/**
 * 用于antdesigns Table数据渲染的key
 * @method addKey
 * @param data {Array} 数据
 * @param str {Array} 标识
 * @return arr {Array} [{}]
 */
const addKey = (data, str) => {
	var arr = [];

	data.map((v, k) => {
		v.key = str + k;
		arr.push(v);
	});

	return arr;
}

/**
 * strToArr
 * 将[1,2] 转变成 1,2
 * @method strToArr
 * @param data {String}
 * @return arr
 */
const strToArr = (data) => {
	var arr = [];
	let a = data.split(",");
	a.map((v, k) => {
		arr.push(parseInt(v, 10));
	});
	return arr;
}

/**
 * 全部权限模块
 * @method userAllow
 * @return {Array} 
 */
const userAllow = () => {
	let list = [{
		key: "1",
		value: "data",
		cnName: "渠道数据",
		url: "/data"
	}, {
		key: "2",
		value: "manager",
		cnName: "渠道管理",
		url: "/manager"
	}, {
		key: "3",
		value: "sys",
		cnName: "系统管理",
		url: "/sys"
	}, {
		key: "4",
		value: "user",
		cnName: "用户管理",
		url: "/user"
	}];

	return list;
}

export {
	//添加key
	addKey,
	//将字符串转换成数组
	strToArr,
	//用户权限
	userAllow
}

```

#### 引用方式

- import {
    userAllow,
    strToArr
    addKey
} from '../../common/utils';

#### 使用方式

- let arr = strToArr('1,2')


### 动态路由切割

> /src/routers/config.js

``` jsx 
 import React from 'react';

 import {
 	Router,
 	Route,
 	IndexRoute,
 	IndexRedirect,
 	Redirect
 } from 'react-router';

 /**
  * 根路由组件
  */
 import Main from '../components/main';

 /**
  * 渠道数据
  */
 import Data from '../components/data/data';

 //渠道数据 -- 用户概况
 import Profile from '../components/profile/profile';

 //渠道数据 -- 用户概况 -- 详情
 const ProfileList = (location, cb) => {
 	require.ensure([], require => {
 		cb(null,
 			require('../components/profile/profileList').default
 		)
 	}, 'profileList')
 }


 //渠道数据 -- KPI报表
 import Kpi from '../components/kpi/kpi';

 //渠道数据 -- KPI报表 -- 详情
 const KpiDetail = (location, cb) => {
 	require.ensure([], require => {
 		cb(null,
 			require('../components/kpi/kpiDetail').default
 		)
 	}, 'kpiDetail')
 }

 /**
  * 渠道管理
  */
 import Manager from '../components/manager/manager';

 //渠道管理 -- 渠道列表
 import Channel from '../components/manager/list/list';
 //渠道管理 -- 渠道列表 -- 详情
 import ChannelList from '../components/manager/list/list/list';

 //渠道管理 -- 渠道组列表 
 import Group from '../components/manager/group/group';
 //渠道管理 -- 渠道组列表 -- 详情
 import ChannelGroup from '../components/manager/group/list/list';


 /**
  * 用户管理
  */
 import User from '../components/user/user';

 // 用户管理 -- 用户列表
 import UserList from '../components/user/userList';
 // 用户管理 -- 用户列表 -- 详情
 const UserListIndex = (location, cb) => {
 	require.ensure([], require => {
 		cb(null,
 			require('../components/user/userListIndex').default
 		)
 	}, 'userListIndex')
 }

 // 用户管理 -- 用户列表 -- 新建用户
 const CreateUser = (location, cb) => {
 	require.ensure([], require => {
 		cb(null,
 			require('../components/user/createUser').default
 		)
 	}, 'createUser')
 }


 // 用户管理 -- 用户列表 -- 修改用户
 const EditUser = (location, cb) => {
 	require.ensure([], require => {
 		cb(null,
 			require('../components/user/editUser').default
 		)
 	}, 'editUser')
 }


 // 没有权限 
 const NoAllow = (location, cb) => {
 	require.ensure([], require => {
 		cb(null,
 			require('../components/noAllow/noAllow').default
 		)
 	}, 'noAllow')
 }

 //Demo
 import Demo from '../components/demo/demo';
 import DemoTable from '../components/demoTable/demoTable';

 const doAllow = (replace) => {

 	var list = [{
 		key: "1",
 		value: "data",
 		cnName: "渠道数据",
 		url: "/data"
 	}, {
 		key: "2",
 		value: "manager",
 		cnName: "渠道管理",
 		url: "/manager"
 	}, {
 		key: "3",
 		value: "sys",
 		cnName: "系统管理",
 		url: "/sys"
 	}, {
 		key: "4",
 		value: "user",
 		cnName: "用户管理",
 		url: "/user"
 	}];


 	if (window.userInfo.data.auth != "") {
 		let winArr = window.userInfo.data.auth.split(",");

 		var firstNum = winArr[0];
 		var path = "";
 		list.map((v, k) => {
 			if (firstNum == v.key) {
 				path = v.url;
 			}
 		});

 		if (path != "") {
 			replace({
 				pathname: path
 			})
 		}
 	}
 }


 const isAllow = (data, replace) => {
 	console.log(data, 'data');

 	var list = [{
 		key: "1",
 		value: "data",
 		cnName: "渠道数据",
 		url: "/data"
 	}, {
 		key: "2",
 		value: "manager",
 		cnName: "渠道管理",
 		url: "/manager"
 	}, {
 		key: "3",
 		value: "sys",
 		cnName: "系统管理",
 		url: "/sys"
 	}, {
 		key: "4",
 		value: "user",
 		cnName: "用户管理",
 		url: "/user"
 	}];

 	var winArr = window.userInfo.data.auth.split(",");

 	var bl = false;
 	winArr.map((v, k) => {
 		if (v == data) {
 			bl = true;
 		}
 	});

 	if (!bl) {
 		var firstNum = winArr[0];
 		var path = "";
 		list.map((v, k) => {
 			if (firstNum == v.key) {
 				path = v.url;
 			}
 		});

 		if (path != "") {
 			replace({
 				pathname: path
 			})
 		} else {

 			replace({
 				pathname: '/noallow'
 			})

 		}

 	}

 }



 export default class Routers extends React.Component {

 	constructor(props) {
 		super(props);
 	}


 	render() {

 		return (
 			<div>
 			<Router history={this.props.history}>	
			  <Route path="/" component={Main}>	
				 <IndexRedirect to="data" />
	          
	            <Route path="data" component={Data} onEnter={
	            	(nextState, replace) => {
	            		let key = "1";
	            		isAllow(key, replace);
	            	}
	            }>
					<IndexRedirect to="profile"  />
	            	
	            	<Route path="profile(/:tab)(/:page)" component={Profile}>
	            		<IndexRoute getComponent={ProfileList} />
	            	</Route>

	            	<Route path="kpi" component={Kpi}>
	            		<IndexRoute getComponent={KpiDetail} />
	            	</Route>

	            	
	            </Route>
	            <Route path="manager" component={Manager}>
	            	<IndexRedirect to="list" />
					<Route  path="list" component={Channel}>
	            		<IndexRoute component={ChannelList} />
	            	</Route>
	            	<Route  path="group" component={Group}>
	            		<IndexRoute component={ChannelGroup} />
	            	</Route>
	            </Route>


	            <Route path="user" component={User} onEnter={
	            	(nextState, replace) => {
	            		let key = "4";
	            		debugger;
	            		isAllow(key, replace);
	            		debugger;
	            	}
	            }>
	            	<IndexRedirect to="list" />
	            	<Route  path="list" component={UserList}>
	            		<IndexRoute getComponent={UserListIndex} />

	            		<Route  path="create" getComponent={CreateUser}></Route>
	            		<Route  path="edit/:id" getComponent={EditUser}></Route>

	            		<Redirect from='*' to='/user/list' />
	            	</Route>
	            </Route>

	            <Route path="demo" component={Demo}>
	            	{/*<IndexRedirect to="demoTable" />*/}
	            	{/*<Route  path="demoTable" component={DemoTable}>*/}
	            		<IndexRoute component={DemoTable} />
	            	{/*</Route> */}
	            </Route>

	            <Route path="noallow" getComponent={NoAllow} onEnter={
	            	(nextState, replace) => {
	            		
	            		doAllow(replace);
	            	}
	            }></Route>
			  
			  </Route>
			  <Redirect from='*' to='data' />
			</Router>
			</div>
 		);
 	}
 }


```

### antd的组件复用

#### 表格

``` jsx

<Table 
    loading={this.props.userList.Param.loading} 
	locale={{"emptyText": "暂无数据"}} 
	columns={columns} 
	dataSource={this.props.userList.listTable.result}
	pagination={pagination}
	onChange={this.handleTableChange.bind(this)}
/>

```

#### 下拉列表

> 操作系统、线上线下、搜索渠道组、搜索渠道 复用的是同一个组件

``` jsx

{/*操作系统开始*/}
<FormItem label="操作系统">
    <Select 
        placeholder="Select a option and change input text above" 
        dropdownMatchSelectWidth={true}  
        value={this.props.profileList.Param.appCode}
        style={{width:'70px'}}
        onChange={this.changeOs.bind(this)}>
        <Option value="">全部</Option>
        <Option value="24">Android</Option>
        <Option value="27">iOS</Option>
    </Select>
</FormItem>
{/*操作系统结束*/}
    
{/*线上、线下开始*/}
<FormItem label="线上\线下">
    <Select 
        placeholder="Select a option and change input text above" 
        dropdownMatchSelectWidth={true}
        value={this.props.profileList.Param.channelCategory}
        onChange={this.changeChannelCategory.bind(this)}
        style={{width:'70px'}}>
        <Option value="">全部</Option>
        <Option value="1">线上</Option>
        <Option value="2">线下</Option>
    </Select>
</FormItem>
{/*线上、线下结束*/}
    
{/*渠道组开始*/}
<FormItem label="渠道组">
    <Select 
        showSearch={true}
        placeholder="搜索渠道组" 
        dropdownMatchSelectWidth={true}
        value={this.props.profileList.Param.channelGroup}
        style={{width:'160px'}}
        optionFilterProp="children"
        onChange={this.handleChange.bind(this)}>
        <Option value="">全部</Option>
        {/*渠道组列表*/}
        {this.renderGroupList()}
    </Select>
</FormItem>
{/*渠道组结束*/}
    
{/*搜索渠道开始*/}
<FormItem label="">
    <Select 
        mode="combobox"
        placeholder="搜索渠道名称"
        notFoundContent="暂无相关数据"
        style={{width:"100px"}}
        defaultActiveFirstOption={false}
        showArrow={false}
        value={this.props.profileList.Param.channelName}
        filterOption={false}
        onChange={this.searchChannel.bind(this)}
         >
         {/* {options}*/}
         {this.getChannelList()}
    </Select>
</FormItem>

```

### redux 共享数据


#### reducer 数据状态

> /src/reducers/userLis/listTable.js

``` javascript

/**
 * 请求参数
 * @method Param
 * @param state {Object} 装态
 * @param action (Object) 动作
 */
const Param = (state, action) => {
	if (typeof state === "undefined") {
		//初始化
		return {
			offset: 1,
			limit: 10,
			name: "",
			loading: false
		};
	}

	switch (action.type) {

		case "USER_LIST_OFFSET":
			//用户列表页 -- 页码
			return Object.assign({}, state, {
				offset: action.payload
			});

		case "USER_LIST_LIST":
			//用户列表页 -- 每页显示多少条 
			return Object.assign({}, state, {
				limit: action.payload
			});

		case "USER_LIST_NAME":
			//用户列表页 -- 搜索的名称
			return Object.assign({}, state, {
				name: action.payload
			});
		case "USER_LIST_LOADING":
			//用户列表页正在加载中
			return Object.assign({}, state, {
				loading: action.payload
			});
		default:
			//返回初始化
			return state;

	}
}

export {
	Param
}

```


#### action 动做

> /src/actions/userList.js

``` javascript


import reqwest from 'reqwest';
import React from 'react';

import {
	notification
} from 'antd';

const addUser = (data, callback) => {
	console.log('###参数###', data);

	return function(dispatch) {
		//发送请求
		reqwest({
			url: '/user/add.do',
			method: 'post',
			data: data,
			type: 'json',
			header: {
				"aaa": "bbb"
			}
		}).then((msg) => {


			if (msg.status) {
				notification['success']({
					message: '添加成功',
					description: msg.msg,
				});

				callback(true);
			} else {
				notification['error']({
					message: '添加失败',
					description: msg.msg,
				});
			}

			if (msg.msg == -1) {
				props.router.push('/login');
			}
		});
	}

}

export {
	addUser
};

```

#### 用 connect 将数据和方法共享

``` javascript 


//将reducer的数据绑定到props上
const mapStateToProps = (state) => {
	return {
		userList: state.userList
	}
};

//将action的所有方法绑定到props上
const mapDispatchToProps = (dispatch, ownProps) => {

	//全量
	return bindActionCreators(actionCreators, dispatch);

};

export default connect(mapStateToProps, mapDispatchToProps)(UserListIndex);

```


## 重构节点 开发到结束，最少22.8天 
- 有些交互点需要和产品变通
- 先完成
	- 交互先做
		- 渠道数据 -- 用户概况 【完成】
		- 渠道数据 -- KPI报表
		- 用户管理 -- 用户列表 【完成】
	- 调整样式 （其它页面复用）

- 后需页面 -- 只是预估 
	- 一个模块计划大概一天
	- 渠道数据 — 模块个数10
		- 整体趋势
		- 留存分析
		- 用户构成
		- 流量分布
		- 用户质量
		- 站外唤醒
		- 终端品牌
		- 广告曝光
		- 渠道ROI
		- KPI报表
	- 渠道管理 — 模块个数4
		- 渠道列表
		- 渠道分组
		- 短链管理
		- 渠道成本
	- 系统管理 — 模块个数1
		- 机型管理
	- 样式 1d
	- icons  0.5d
	- Excel 下载统一做 1.5d
	- Excel 名称提取 1d
    - 对比功能在新版上线后空闲时间实现

- 整体开发整体测试
	- 分两轮


## 重构后的好处

- 向上迭代快
- 可以应对复杂的需求
- 操作反馈等一些基础功能会更加人性化
- 通过前后端合理解耦，使期开发效率合理提高（短、平、快）


## 前端阶段

### 第一个阶段

- 基础方案
- 做通、做顺、做快

### 第二个阶段

- 稀有技术点的积累和提高


## 文档

> 和前端有关的文档

| 文档 | 是否必需 |
| :-------------- | :---------: |
| 原型图(原型文档）| √  |
| 交互稿（交互文档）| ㄨ√  |
| 视觉稿（视觉文档）| ㄨ√  |
| 接口文档 | √  |
| 交接文档 | √  |



## 自动化

### 自动构建  ㄨ
### 自动部署  ㄨ

## 发现和调研

### react-dnd

- https://react-dnd.github.io/react-dnd/examples-nesting-drag-sources.html

### react-grid-layout

- https://github.com/STRML/react-grid-layout
- https://strml.github.io/react-grid-layout/examples/11-no-vertical-compact.html 【demo】
- http://demo.thorpora.fr/ez-dashing/ 【demo】